flake8: &flake8
  name: Verifies pep8, pyflakes and circular complexit
  command: |
            pip3 install flake8
            python3 -m flake8 odd
            python3 -m demo

install_odd: &install_odd
  name: Install odd
  command: |
            pip3 install -e . --no-deps

run_demo_mpi: &run_demo_mpi
  name: run demos MPI
  command: |
            cd demo/poisson
            mpirun -n 3 python3 poisson.py
            mpirun -n 3 python3 poisson_petsc.py

run_test_serial: &run_test_serial
  name: run tests serial
  command: |
            cd test
            python3 -m pytest -v .

version: 2
jobs:
  build:
    docker:
      - image: quay.io/fenicsproject/dolfinx:complex
    steps:
      - checkout
      - run: *flake8
      - run: *install_odd
      - run: *run_demo_mpi
      - run: *run_test_serial

workflows:
  version: 2
  build_and_test:
    jobs:
      - build
